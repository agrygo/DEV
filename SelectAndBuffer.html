<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
  on iOS devices-->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>Select and Buffer</title>

  <link rel="stylesheet" href="http://js.arcgis.com/3.12/dijit/themes/claro/claro.css">
  <link rel="stylesheet" href="http://js.arcgis.com/3.12/esri/css/esri.css" />

  <script src="http://js.arcgis.com/3.12/"></script>
  <script>
    var map;

    require([
      "esri/InfoTemplate",
      "esri/map",
      "esri/graphic",
      "esri/layers/FeatureLayer",
      "esri/symbols/SimpleFillSymbol",
      "esri/symbols/SimpleLineSymbol",
      "esri/geometry/Extent", 
      "esri/geometry/normalizeUtils",
      "esri/tasks/query",
      "esri/tasks/BufferParameters",
      "esri/tasks/GeometryService",
      "esri/toolbars/draw",
      "dojo/dom",
      "dojo/on",
      "dojo/parser",
      "dojo/_base/array",
      "esri/Color",
      "dijit/form/Button",
      "dojo/domReady!"
    ],
      function (
        InfoTemplate, Map, Graphic, FeatureLayer, SimpleFillSymbol, SimpleLineSymbol, Extent, normalizeUtils, Query, BufferParameters, GeometryService, Draw, dom, on, parser, array, arrayUtil, Color
      ) {

       
       // esriConfig.defaults.geometryService = new GeometryService("http://vgis8app:6080/arcgis/rest/services/Utilities/Geometry/GeometryServer");

        //esriConfig.defaults.io.proxyUrl = "/proxy/";
        //esriConfig.defaults.io.alwaysUseProxy = false;

        
       parser.parse();

        var selectionToolbar, featureLayer;

        map = new Map("map", {
          basemap: "topo",
          //center: [ -107.918, 39.617 ],
          extent: new
          Extent ({"xmin":-11949053.31109845,"ymin":4799551.289959352,"xmax":-11945709.191110885,"ymax":4801939.947093327,"spatialReference":{"wkid":102100,"latestWkid":3857}}),
          zoom: 16
        });

        map.on("load", initSelectToolbar);

        var fieldsSelectionSymbol =
          new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
            new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT,
          new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.5]));

        var content = "<b>Owner</b>: ${NAME}";
        var infoTemplate = new InfoTemplate("${PARCELNB}", content);

        featureLayer = new FeatureLayer("http://vgis8app:6080/arcgis/rest/services/Development/GC_Cadastral/MapServer/3",
          {
            mode: FeatureLayer.MODE_ONDEMAND,
            infoTemplate: infoTemplate,
            outFields: ["*"]
          });

        //featureLayer.setDefinitionExpression("PROD_GAS='Yes'");
        featureLayer.setSelectionSymbol(fieldsSelectionSymbol);
        //featureLayer.on("selection-complete", sumGasProduction);
        featureLayer.on("selection-clear", function () {
          dom.byId('messages').innerHTML = "<i>No Selected Fields</i>";
        });
        map.addLayer(featureLayer);

        on(dom.byId("selectFieldsButton"), "click", function () {
          selectionToolbar.activate(Draw.EXTENT);
        });

        on(dom.byId("clearSelectionButton"), "click", function () {
          featureLayer.clearSelection();
        });

        function initSelectToolbar (event) {
          selectionToolbar = new Draw(event.map);
          var selectQuery = new Query();

          on(selectionToolbar, "DrawEnd", function (geometry) {
            selectionToolbar.deactivate();
            selectQuery.geometry = geometry;
            featureLayer.selectFeatures(selectQuery,
              FeatureLayer.SELECTION_NEW);
          });
        };

        
     
          //var graphic = new Graphic(geometry);
          //map.graphics.add(graphic);

         /*function doBuffer(event){
          selectionToolbar.deactivate();
          var geometry = event.geometry;

          var graphic = new Graphic(geometry);
          map.graphics.add(graphic);

          //setup the buffer parameters
          var params = new BufferParameters();
          params.distances = [ dom.byId("distance").value ];
          params.outSpatialReference = map.spatialReference;
          params.unit = GeometryService[dom.byId("unit").value];
          //normalize the geometry 

         normalizeUtils.normalizeCentralMeridian([geometry], esriConfig.defaults.geometryService).then(function(normalizedGeometries) {
            var normalizedGeometry = normalizedGeometries[0];
            if (normalizedGeometry.type === "polygon") {
              //if geometry is a polygon then simplify polygon.  This will make the user drawn polygon topologically correct.
              esriConfig.defaults.geometryService.simplify([normalizedGeometry], function(geometries) {
                params.geometries = geometries;
                esriConfig.defaults.geometryService.buffer(params, showBuffer);
              });
            } else {
              params.geometries = [normalizedGeometry];
              esriConfig.defaults.geometryService.buffer(params, showBuffer);
            }

          });
        
   

             function showBuffer(bufferedGeometries) {
              var symbol = new SimpleFillSymbol(
                SimpleFillSymbol.STYLE_SOLID,
                new SimpleLineSymbol(
                  SimpleLineSymbol.STYLE_SOLID,
                  new Color([255,0,0,0.65]), 2
                ),
                new Color([255,0,0,0.35])
              );

              array.forEach(bufferedGeometries, function(geometry) {
                var graphic = new Graphic(geometry, symbol);
                map.graphics.add(graphic);
              });

            }*/
        /*function sumGasProduction (event) {
          var productionSum = 0;
          //summarize the cumulative gas production to display
          arrayUtil.forEach(event.features, function (feature) {
            productionSum += feature.attributes.CUMM_GAS;
          });
          dom.byId('messages').innerHTML = "<b>Selected Fields Production: " +
                                            productionSum + " mcf. </b>";
        }*/
      });
  
  </script>
</head>

<body class="claro">
  <button id="selectFieldsButton" data-dojo-type="dijit/form/Button">Select Fields</button>
  <button id="clearSelectionButton" data-dojo-type="dijit/form/Button">Clear Selection</button><br>
  Distance: <input type="text" id="distance" size="5" value="25" />
    <select id="unit" style="width:100px;">
      <option value="UNIT_FOOT">Feet</option>
      <option value="UNIT_STATUTE_MILE">Miles</option>
      <option value="UNIT_METER">Meters</option>
      <option value="UNIT_KILOMETER">Kilometers</option>
      
      
    </select><br />
  <div id="map" style="position: relative; width:700px; height:500px; border:1px solid #000;"></div>
  <span id="messages"></span>
</body>

</html>